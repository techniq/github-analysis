<script lang="ts">
  import { flatRollup, max, min, sum } from 'd3-array';
  import { scaleTime } from 'd3-scale';

  import { mdiCalendarRange, mdiPackage, mdiPlay } from '@mdi/js';

  import {
    Button,
    Card,
    DateRange,
    DateRangeDisplay,
    DateRangeField,
    PeriodType,
    TextField,
    getSettings,
    sort
  } from 'svelte-ux';
  import { getDateFuncsByPeriodType } from 'svelte-ux/utils/date';

  import {
    Area,
    Axis,
    Chart,
    Highlight,
    LinearGradient,
    Svg,
    Tooltip,
    TooltipItem
  } from 'layerchart';

  import { goto } from '$app/navigation';

  export let data;

  const { format, localeSettings } = getSettings();

  let pkg = data.variables.pkg;

  let dateRange: DateRange = {
    periodType: PeriodType.Day, // TODO: DateRange needs to improve WeekMon support
    from: data.variables.from,
    to: data.variables.to
  };

  function run() {
    const params = new URLSearchParams();
    params.set('pkg', pkg);
    params.set('from', dateRange.from);
    params.set('to', dateRange.to);
    goto(`?${params}`);
  }

  $: dateFuncs = getDateFuncsByPeriodType($localeSettings, dateRange.periodType);

  $: chartData = sort(
    flatRollup(
      data.downloads,
      (values) => {
        return {
          start: min(values, (d) => d.day),
          end: max(values, (d) => d.day),
          downloads: sum(values, (d) => d.downloads)
        };
      },
      (d) => dateFuncs.start(d.day)
    ).map((d) => d[1]),
    (d) => d.start
  );
</script>

<svelte:head>
  <title>{pkg} - Download Statistics - GitHub Analysis</title>
  <meta name="description" content="Analyze download statistics for the {pkg} package. Visualize download trends over time and gain insights into package popularity." />

  <!-- Open Graph meta tags for social media sharing -->
  <meta property="og:title" content="{pkg} - Package Download Insights" />
  <meta property="og:description" content="Analyze download statistics for the {pkg} package. Visualize download trends over time and gain insights into package popularity." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://github.techniq.dev/downloads?pkg={pkg}" /> 
  <meta property="og:image" content="https://github.techniq.dev/opengraph-image-downloads.jpg" /> <!-- Replace with a relevant image URL -->

  <!-- Twitter Card meta tags -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="{pkg} - Package Download Insights" />
  <meta name="twitter:description" content="Analyze download statistics for the {pkg} package. Visualize download trends over time and gain insights into package popularity." />
  <meta name="twitter:image" content="https://github.techniq.dev/twitter-image-downloads.jpg" /> <!-- Replace with a relevant image URL -->

  <!-- Canonical URL -->
  <link rel="canonical" href="https://github.techniq.dev/downloads?pkg={pkg}" />

  <!-- Additional meta tags for better SEO -->
  <meta name="keywords" content="package downloads, {pkg}, statistics, analysis, visualization, trends, popularity" />
  <meta name="robots" content="index, follow" />
</svelte:head>


<main>
  <form class="flex gap-2 border-b bg-surface-100 p-4" on:submit|preventDefault={run}>
    <TextField
      label="Package"
      bind:value={pkg}
      icon={mdiPackage}
      dense
      placeholder="Package"
      class="flex-1"
    />
    <DateRangeField
      label="Date Range"
      bind:value={dateRange}
      icon={mdiCalendarRange}
      dense
      periodTypes={[PeriodType.Day, PeriodType.WeekSun, PeriodType.Month, PeriodType.CalendarYear]}
      on:change={run}
      class="flex-1"
    />
    <Button type="submit" icon={mdiPlay} variant="fill" color="primary">Run</Button>
  </form>

  <div class="grid gap-4 p-4">
    <Card
      title={data.variables.pkg}
      subheading="{$format(
        sum(data?.downloads ?? [], (d) => d.downloads),
        'integer'
      )} total downloads"
      class="h-[300px]"
    >
      <Chart
        data={chartData}
        x="start"
        xScale={scaleTime()}
        y="downloads"
        yDomain={[0, null]}
        yNice
        padding={{ left: 36, bottom: 32, right: 24 }}
        tooltip={{ mode: 'bisect-x' }}
      >
        <Svg>
          <Axis placement="left" grid rule format="metric" />
          <Axis placement="bottom" format={(d) => $format(d, PeriodType.Day)} rule />
          <LinearGradient class="from-secondary/50 to-secondary/0" vertical let:url>
            <Area line={{ class: 'stroke-2 stroke-secondary' }} fill={url} tweened />
          </LinearGradient>
          <Highlight points={{ class: 'fill-secondary' }} lines />
        </Svg>

        <Tooltip let:data>
          <div slot="header" let:data>
            <DateRangeDisplay
              value={{ from: data.start, to: data.end, periodType: dateRange.periodType }}
            />
          </div>
          <TooltipItem label="Downloads" value={data.downloads} format="integer" />
        </Tooltip>
      </Chart>
    </Card>
  </div>
</main>
